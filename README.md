# 1주차 과제
## 주제: TDD로 개발하기
## 일정: 2024 년 9월 21일 ~ 27일

## 개요
### 필수 사항
- 테스트 케이스의 작성 및 작성 이유를 주석으로 작성
- 설정 및 database패키지 구현체 수정 없이 활용하여 기능 구현
- 분산환경 고려하지 않음

### 요건
포인트 조회, 포인트 충전/사용 내역 조회, 충전, 사용
```
- PATCH  `/point/{id}/charge` : 포인트를 충전한다.
- PATCH `/point/{id}/use` : 포인트를 사용한다.
- GET `/point/{id}` : 포인트를 조회한다.
- GET `/point/{id}/histories` : 포인트 내역을 조회한다.
```
- 잔고가 부족할 경우, 포인트 사용은 실패
- 동시에 여러 건의 포인트 충전, 이용 요청이 들어올 경우 순차적으로 처리되어야 함

### pass 조건
lv.0
- `/point` 패키지 (디렉토리) 내에 `PointService` 기본 기능 작성
- `/database` 패키지의 구현체는 수정하지 않고, 이를 활용해 기능을 구현
- 각 기능에 대한 단위 테스트 작성

lv.1
- 포인트 충전, 사용에 대한 정책 추가 (잔고 부족, 최대 잔고 등)
- 동시에 여러 요청이 들어오더라도 순서대로 (혹은 한번에 하나의 요청씩만) 제어될 수 있도록 리팩토링
- 동시성 제어에 대한 통합 테스트 작성
    
lv.2
- 동시성 제어 방식에 대한 분석 및 보고서 작성 ( **README.md** )

---
# 작업 기록

## 요건 분석 및 설계
### 테이블
- UserPointTable

|컬럼 명|타입|설명|
|---|---|---|
|id|long|사용자 식별 id|
|point|long|해당 사용자의 잔여 point|
|updateMillis|long|업데이트 일자(밀리초 단위, 타임스탬프)|

- PointHistoryTable

|컬럼 명|타입|설명|
|---|---|---|
|id|long|트랜잭션 식별 id|
|userId|long|사용자 식별 id|
|amount|long|포인트 변경 금액|
|type|TransactionType|트랜잭션 유형 (CHARGE, USE)|
|updateMillis|long|업데이트 일자(밀리초 단위, 타임스탬프)|

### 포인트 조회

(컨트롤러) 1. 파라미터 수신: 사용자가 조회할 포인트 관련 정보를 담은 파라미터를 넘겨받는다. 
(컨트롤러) 2. 파라미터 검증: 수신한 파라미터의 유효성을 검사하여 필수 값이 포함되어 있는지, 형식이 올바른지 확인한다.
(서비스) 3. 데이터 요청: 검증된 파라미터를 기반으로 UserPointTable 데이터를 요청, 리턴
(컨트롤러) 4. 결과 반환: 최종적으로 조회된 포인트 데이터를 사용자에게 반환한다.

- 컨트롤러 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|잘못된 형식의 id가 포함된 요청을 수신했을 때, 에러가 발생하는지 확인|
|2|실패|서비스 레이어가 예외를 발생시킬 때, 컨트롤러가 적절히 에러를 반환하는지 확인|
|3|성공|유효한 파라미터가 전달되었을 때, 파라미터 검증이 정상적으로 통과되는지 확인|
|4|성공|유효한 id가 포함된 요청을 수신했을 때, 컨트롤러가 정상적으로 실행되는지 확인|

- 서비스 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|존재하지 않는 id에 대해 요청할 때, null 또는 예외가 발생하는지 확인|
|2|실패|데이터베이스 접근 중 예외가 발생할 때, 이를 적절히 처리하는지 확인|
|3|성공|유효한 id가 주어졌을 때, 올바른 UserPoint 데이터를 반환하는지 확인|


### 포인트 충전/사용 내역 조회
(컨트롤러) 1. 파라미터 수신: 사용자가 조회할 포인트 관련 정보를 담은 파라미터를 넘겨받는다. 
(컨트롤러) 2. 파라미터 검증: 수신한 파라미터의 유효성을 검사하여 필수 값이 포함되어 있는지, 형식이 올바른지 확인한다.
(서비스)) 3. 데이터 요청: 검증된 파라미터를 기반으로 PointHistoryTable 데이터를 요청, 리턴
(컨트롤러) 4. 결과 반환: 최종적으로 조회된 포인트 사용/충전 내역 데이터를 사용자에게 반환한다.

- 컨트롤러 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|잘못된 형식의 id가 포함된 요청을 수신했을 때, 에러가 발생하는지 확인|
|2|실패|서비스 레이어가 예외를 발생시킬 때, 컨트롤러가 적절히 에러를 반환하는지 확인|
|3|성공|유효한 파라미터가 전달되었을 때, 파라미터 검증이 정상적으로 통과되는지 확인|
|4|성공|유효한 id가 포함된 요청을 수신했을 때, 컨트롤러가 정상적으로 실행되는지 확인|

- 서비스 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|존재하지 않는 id에 대해 요청할 때, null 또는 예외가 발생하는지 확인|
|2|실패|데이터베이스 접근 중 예외가 발생할 때, 이를 적절히 처리하는지 확인|
|3|성공|유효한 id가 주어졌을 때, 올바른 PointHistory 데이터를 반환하는지 확인|

### 포인트 충전
(컨트롤러) 1. 파라미터 수신: 사용자가 조회할 포인트 관련 정보를 담은 파라미터를 넘겨받는다. 
(컨트롤러) 2. 파라미터 검증: 수신한 파라미터의 유효성을 검사하여 필수 값이 포함되어 있는지, 형식이 올바른지 확인한다.
(서비스) 3. 비즈니스 로직 수행: 검증된 파라미터를 기반으로 UserPointTable애서 해당 사용자의 포인트를 조회한다. amount만큼 포인트를 증가시킨다.
(서비스) 4. 통계 저장: 포인트 충전 내역을 PointHistoryTable에 저장한다.
(컨트롤러) 5. 결과 반환: 최종적으로 업데이트된 사용자 포인트 정보를 포함하여 응답을 반환한다.

- 컨트롤러 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|잘못된 형식의 id가 포함된 요청을 수신했을 때, 에러가 발생하는지 확인|
|2|실패|서비스 레이어가 예외를 발생시킬 때, 컨트롤러가 적절히 에러를 반환하는지 확인|
|3|성공|유효한 파라미터가 전달되었을 때, 파라미터 검증이 정상적으로 통과되는지 확인|
|4|성공|유효한 id가 포함된 요청을 수신했을 때, 컨트롤러가 정상적으로 실행되는지 확인|

- 서비스 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|존재하지 않는 id에 대해 요청할 때, 예외가 발생하는지 확인|
|2|실패|데이터베이스 접근 중 예외가 발생할 때, 이를 적절히 처리하는지 확인|
|3|실패|포인트 충전이 실패했을 경우 통계 저장이 이루어지지 않는지 확인|
|4|실패|최대잔고이상 충전을 시도할 때, 예외가 발생하는지 확인|
|5|성공|유효한 파라미터가 주어졌을 때, 포인트가 성공적으로 증가하는지 확인|
|6|성공|포인트 충전 내역이 PointHistoryTable에 제대로 저장되는지 확인|


### 포인트 사용
(컨트롤러) 1. 파라미터 수신: 사용자가 조회할 포인트 관련 정보를 담은 파라미터를 넘겨받는다. 
(컨트롤러) 2. 파라미터 검증: 수신한 파라미터의 유효성을 검사하여 필수 값이 포함되어 있는지, 형식이 올바른지 확인한다.
(서비스) 3. 비즈니스 로직 수행: 검증된 파라미터를 기반으로 UserPointTable애서 해당 사용자의 포인트를 조회한다. amount만큼 포인트를 차감시킨다.
(서비스) 4. 통계 저장: 포인트 충전 내역을 PointHistoryTable에 저장한다.
(컨트롤러) 5. 결과 반환: 최종적으로 업데이트된 사용자 포인트 정보를 포함하여 응답을 반환한다.

- 컨트롤러 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|잘못된 형식의 id가 포함된 요청을 수신했을 때, 에러가 발생하는지 확인|
|2|실패|서비스 레이어가 예외를 발생시킬 때, 컨트롤러가 적절히 에러를 반환하는지 확인|
|3|성공|유효한 파라미터가 전달되었을 때, 파라미터 검증이 정상적으로 통과되는지 확인|
|4|성공|유효한 id가 포함된 요청을 수신했을 때, 컨트롤러가 정상적으로 실행되는지 확인|

- 서비스 단위 테스트 시나리오

|Test case 번호|type|설명|
|---|---|-----|
|1|실패|존재하지 않는 id에 대해 요청할 때, 예외가 발생하는지 확인|
|2|실패|데이터베이스 접근 중 예외가 발생할 때, 이를 적절히 처리하는지 확인|
|3|실패|포인트 사용이 실패했을 경우 통계 저장이 이루어지지 않는지 확인|
|4|실패|잔액부족 시 사용을 시도할 때, 예외가 발생하는지 확인|
|5|성공|유효한 파라미터가 주어졌을 때, 포인트가 성공적으로 증가하는지 확인|
|6|성공|포인트 충전 내역이 PointHistoryTable에 제대로 저장되는지 확인|



